<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Language" content="en" />
<title>added the ability to submit albums - albumify-next - Next gen albumify, written in Go. Uses mongodb. WIP!
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="albumify-next.git Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>albumify-next</h1><span class="desc">Next gen albumify, written in Go. Uses mongodb. WIP!
</span></td></tr><tr class="url"><td></td><td>git clone <a href="git://thetudor.ddns.net/albumify-next.git">git://thetudor.ddns.net/albumify-next.git</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/1e004f18f90c925348dab55c71f0398e5753d713.html">1e004f18f90c925348dab55c71f0398e5753d713</a>
<b>parent</b> <a href="../commit/1b67b9dc835d2bcb37e6fbc00fdf77d5d4f8d170.html">1b67b9dc835d2bcb37e6fbc00fdf77d5d4f8d170</a>
<b>Author:</b> Tudor &lt;<a href="mailto:xenogenesis@openmailbox.org">xenogenesis@openmailbox.org</a>&gt;
<b>Date:</b>   Fri Jun  3 14:44:24 +0300

added the ability to submit albums

<b>Diffstat:</b>
<table><tr><td><a href="#h0">config.json</a></td><td> | </td><td class="num">4</td><td><span class="i">+++</span><span class="d">-</span></td></tr>
<tr><td><a href="#h1">controllers/albums.go</a></td><td> | </td><td class="num">29</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td><a href="#h2">main.go</a></td><td> | </td><td class="num">7</td><td><span class="i">++++</span><span class="d">---</span></td></tr>
<tr><td><a href="#h3">util/config.go</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++</span><span class="d">----</span></td></tr>
<tr><td><a href="#h4">util/db.go</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td><a href="#h5">util/router.go</a></td><td> | </td><td class="num">4</td><td><span class="i">+</span><span class="d">---</span></td></tr>
</table>6 files changed, 44 insertions(+), 13 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.json.html">config.json</a> b/<a href="../file/config.json.html">config.json</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,5 +1,7 @@
</a> {
<a href="#h0-0-1" id="h0-0-1" class="i">+    &quot;ServerHostname&quot;: &quot;localhost&quot;,
</a>     &quot;ServerPort&quot;: 8080,
     &quot;ApiEndpoint&quot;: &quot;/api&quot;,
<a href="#h0-0-4" id="h0-0-4" class="d">-    &quot;DatabaseAddress&quot;: &quot;localhost&quot;
</a><a href="#h0-0-5" id="h0-0-5" class="i">+    &quot;DatabaseAddress&quot;: &quot;localhost&quot;,
</a><a href="#h0-0-6" id="h0-0-6" class="i">+    &quot;DatabaseName&quot;: &quot;albumify&quot;
</a> }
<b>diff --git a/<a id="h1" href="../file/controllers/albums.go.html">controllers/albums.go</a> b/<a href="../file/controllers/albums.go.html">controllers/albums.go</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -2,6 +2,7 @@ package controllers
</a> 
 import (
 	&quot;encoding/json&quot;
<a href="#h1-0-3" id="h1-0-3" class="i">+	&quot;fmt&quot;
</a> 	&quot;net/http&quot;
 
 	&quot;github.com/gorilla/mux&quot;
<a href="#h1-1" id="h1-1" class="h">@@ -14,12 +15,15 @@ import (
</a> 
 const prefix string = &quot;/albums&quot;
 
<a href="#h1-1-3" id="h1-1-3" class="i">+var subrouter *mux.Router
</a> var collection *mgo.Collection
 
 func AlbumRegisterController() {
<a href="#h1-1-7" id="h1-1-7" class="i">+	subrouter = util.Router.PathPrefix(prefix).Subrouter()
</a> 	collection = util.GetDB().C(&quot;albums&quot;)
 
<a href="#h1-1-10" id="h1-1-10" class="d">-	util.Router.HandleFunc(prefix+&quot;/{albumId}&quot;, AlbumShow)
</a><a href="#h1-1-11" id="h1-1-11" class="i">+	subrouter.HandleFunc(&quot;/{albumId}&quot;, AlbumShow).Methods(&quot;GET&quot;)
</a><a href="#h1-1-12" id="h1-1-12" class="i">+	subrouter.HandleFunc(&quot;/&quot;, AlbumSubmit).Methods(&quot;GET&quot;, &quot;POST&quot;)
</a> }
 
 func AlbumShow(w http.ResponseWriter, r *http.Request) {
<a href="#h1-2" id="h1-2" class="h">@@ -34,3 +38,26 @@ func AlbumShow(w http.ResponseWriter, r *http.Request) {
</a> 		json.NewEncoder(w).Encode(result)
 	}
 }
<a href="#h1-2-3" id="h1-2-3" class="i">+
</a><a href="#h1-2-4" id="h1-2-4" class="i">+func AlbumSubmit(w http.ResponseWriter, r *http.Request) {
</a><a href="#h1-2-5" id="h1-2-5" class="i">+	var album, prevAlbum models.Album
</a><a href="#h1-2-6" id="h1-2-6" class="i">+	decoder := json.NewDecoder(r.Body)
</a><a href="#h1-2-7" id="h1-2-7" class="i">+	err := decoder.Decode(&amp;album)
</a><a href="#h1-2-8" id="h1-2-8" class="i">+	// TODO: validation
</a><a href="#h1-2-9" id="h1-2-9" class="i">+	if err != nil {
</a><a href="#h1-2-10" id="h1-2-10" class="i">+		http.Error(w, &quot;bad request&quot;, http.StatusBadRequest)
</a><a href="#h1-2-11" id="h1-2-11" class="i">+		util.Logger.Printf(&quot;Bad Request in album submission: %s&quot;, err)
</a><a href="#h1-2-12" id="h1-2-12" class="i">+	}
</a><a href="#h1-2-13" id="h1-2-13" class="i">+	err = collection.Find(bson.M{}).Sort(&quot;-_id&quot;).One(&amp;prevAlbum)
</a><a href="#h1-2-14" id="h1-2-14" class="i">+	if err != nil {
</a><a href="#h1-2-15" id="h1-2-15" class="i">+		http.Error(w, &quot;internal server error&quot;, http.StatusInternalServerError)
</a><a href="#h1-2-16" id="h1-2-16" class="i">+		util.Logger.Printf(&quot;Couldn&apos;t get last album in collection: %s&quot;, err)
</a><a href="#h1-2-17" id="h1-2-17" class="i">+	}
</a><a href="#h1-2-18" id="h1-2-18" class="i">+	album.Id = prevAlbum.Id + 1
</a><a href="#h1-2-19" id="h1-2-19" class="i">+	err = collection.Insert(album)
</a><a href="#h1-2-20" id="h1-2-20" class="i">+	if err != nil {
</a><a href="#h1-2-21" id="h1-2-21" class="i">+		http.Error(w, &quot;internal server error&quot;, http.StatusInternalServerError)
</a><a href="#h1-2-22" id="h1-2-22" class="i">+		util.Logger.Printf(&quot;Couldn&apos;t insert album in collection: %s&quot;, err)
</a><a href="#h1-2-23" id="h1-2-23" class="i">+	}
</a><a href="#h1-2-24" id="h1-2-24" class="i">+	fmt.Fprintf(w, &quot;{\&quot;code\&quot;: \&quot;%s\&quot;}&quot;, util.UrlEncode(album.Id))
</a><a href="#h1-2-25" id="h1-2-25" class="i">+}
</a><b>diff --git a/<a id="h2" href="../file/main.go.html">main.go</a> b/<a href="../file/main.go.html">main.go</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -2,10 +2,10 @@ package main
</a> 
 import (
 	&quot;flag&quot;
<a href="#h2-0-3" id="h2-0-3" class="i">+	&quot;fmt&quot;
</a> 	&quot;log&quot;
 	&quot;net/http&quot;
 	&quot;os&quot;
<a href="#h2-0-7" id="h2-0-7" class="d">-	&quot;strconv&quot;
</a> 
 	&quot;github.com/gorilla/handlers&quot;
 
<a href="#h2-1" id="h2-1" class="h">@@ -27,6 +27,7 @@ func main() {
</a> 
 	controllers.AlbumRegisterController()
 
<a href="#h2-1-3" id="h2-1-3" class="d">-	util.Logger.Printf(&quot;Listening on port %d&quot;, util.Config.ServerPort)
</a><a href="#h2-1-4" id="h2-1-4" class="d">-	log.Fatal(http.ListenAndServe(&quot;:&quot;+strconv.Itoa(util.Config.ServerPort), handlers.LoggingHandler(os.Stdout, util.Router)))
</a><a href="#h2-1-5" id="h2-1-5" class="i">+	address := fmt.Sprintf(&quot;%s:%d&quot;, util.Config.ServerHostname, util.Config.ServerPort)
</a><a href="#h2-1-6" id="h2-1-6" class="i">+	util.Logger.Printf(&quot;Listening on %s&quot;, address)
</a><a href="#h2-1-7" id="h2-1-7" class="i">+	log.Fatal(http.ListenAndServe(address, handlers.LoggingHandler(os.Stdout, util.Router)))
</a> }
<b>diff --git a/<a id="h3" href="../file/util/config.go.html">util/config.go</a> b/<a href="../file/util/config.go.html">util/config.go</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -6,15 +6,17 @@ import (
</a> )
 
 type ConfigStructure struct {
<a href="#h3-0-3" id="h3-0-3" class="d">-	ServerPort  int
</a><a href="#h3-0-4" id="h3-0-4" class="d">-	ApiEndpoint string
</a><a href="#h3-0-5" id="h3-0-5" class="d">-    DatabaseAddress string
</a><a href="#h3-0-6" id="h3-0-6" class="i">+	ServerHostname  string
</a><a href="#h3-0-7" id="h3-0-7" class="i">+	ServerPort      int
</a><a href="#h3-0-8" id="h3-0-8" class="i">+	ApiEndpoint     string
</a><a href="#h3-0-9" id="h3-0-9" class="i">+	DatabaseAddress string
</a><a href="#h3-0-10" id="h3-0-10" class="i">+	DatabaseName    string
</a> }
 
 var Config ConfigStructure
 
 func ReadConfig(filePath string) {
<a href="#h3-0-16" id="h3-0-16" class="d">-    Logger.Printf(&quot;Reading config from %s&quot;, filePath)
</a><a href="#h3-0-17" id="h3-0-17" class="i">+	Logger.Printf(&quot;Reading config from %s&quot;, filePath)
</a> 	rawData, err := ioutil.ReadFile(filePath)
 	if err != nil {
 		Logger.Fatalf(&quot;Error while reading config file: %s&quot;, err)
<b>diff --git a/<a id="h4" href="../file/util/db.go.html">util/db.go</a> b/<a href="../file/util/db.go.html">util/db.go</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -16,5 +16,6 @@ func GetDBSession() {
</a> }
 
 func GetDB() *mgo.Database {
<a href="#h4-0-3" id="h4-0-3" class="d">-	return DBSession.DB(&quot;albumify&quot;)
</a><a href="#h4-0-4" id="h4-0-4" class="i">+	Logger.Printf(&quot;Got database %s&quot;, Config.DatabaseName)
</a><a href="#h4-0-5" id="h4-0-5" class="i">+	return DBSession.DB(Config.DatabaseName)
</a> }
<b>diff --git a/<a id="h5" href="../file/util/router.go.html">util/router.go</a> b/<a href="../file/util/router.go.html">util/router.go</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,8 +1,6 @@
</a> package util
 
<a href="#h5-0-2" id="h5-0-2" class="d">-import (
</a><a href="#h5-0-3" id="h5-0-3" class="d">-	&quot;github.com/gorilla/mux&quot;
</a><a href="#h5-0-4" id="h5-0-4" class="d">-)
</a><a href="#h5-0-5" id="h5-0-5" class="i">+import &quot;github.com/gorilla/mux&quot;
</a> 
 var MainRouter *mux.Router
 var Router *mux.Router
</pre>
</div>
</body>
</html>
